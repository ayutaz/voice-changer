# voice-changer: ONNX変換とUnity Sentis対応ロードマップ

更新日: 2026-02-14  
対象リポジトリ: `voice-changer`  
関連調査: `docs/onnx_unity_sentis_research_ja.md`

## 1. 目的

- RVC系モデルをUnity上で安定動作させるため、ONNX変換パイプラインとSentis実行パイプラインを実装・検証する。
- 既存のONNX Runtime向け経路を維持しつつ、Sentis向け経路を追加して安全に段階導入する。

## 2. スコープ

- ONNXエクスポータのSentis互換化（opset/型/shapeの調整）。
- `uv` ベースの再現可能な変換・検証フロー整備。
- Unity Sentisでの最小推論動作確認から、実運用前チェックまでの実行計画策定。

## 3. 非スコープ

- 学習アルゴリズム自体の刷新。
- モデル精度改善を主目的とした再学習。
- すべてのUnityプラットフォーム最適化を初回で完了させること。

## 4. マイルストーン

1. M1: 変換基盤の固定化（2026-02）
- Sentis向けONNXエクスポータ仕様を確定する。
- `uv` 統一の実行手順をドキュメント化する。
- 代表モデルでONNX生成を成功させる。

2. M2: Python側の事前検証（2026-02）
- `onnxruntime` で入出力shape・dtype・推論可否を検証する。
- 変換前後の音声差分を定性確認する。
- エラー時の原因分類表を作成する。

3. M3: Unity Sentis PoC（2026-02 〜 2026-03）
- Unity最小シーンでモデルロードと推論を実行する。
- 入力テンソル組み立て（`feats`, `pitch`, `pitchf`, `sid`, `p_len`）を確認する。
- 非対応オペレータや型不一致の有無を洗い出す。

4. M4: 実運用向け調整（2026-03）
- モデル分割、shape固定化、推論実行順の調整を実施する。
- レイテンシとメモリ使用量を計測し、目標値を設定する。
- Sentisで詰まるケースに対するONNX Runtimeフォールバック手順を確立する。

5. M5: リリース準備（2026-03）
- 変換手順とUnity導入手順を確定版として `docs` に反映する。
- 最低限の回帰確認項目を定義し、チェックリスト化する。
- 運用時トラブルシュート手順を追加する。

## 5. 成果物一覧

1. 仕様・調査
- `docs/onnx_unity_sentis_research_ja.md`（既存）
- `docs/onnx_unity_sentis_roadmap_ja.md`（本書）

2. 実装
- `server/voice_changer/RVC/onnxExporter/export2onnx_sentis.py`
- 変換補助スクリプト（必要に応じて追加）

3. 手順書
- `uv` を使った依存解決・変換・検証コマンド集
- Unity Sentis統合手順

## 6. 実行タスク（優先順）

1. 代表モデルを固定し、Sentis向けONNXを生成する。
2. `uv run` でONNX推論検証を自動化する。
3. Unity側PoCシーンを作成し、ロードと推論を確認する。
4. 非対応オペレータ発生時の回避策を実装する。
5. パフォーマンス計測と目標値管理を行う。
6. ドキュメントを運用可能な形に仕上げる。

## 7. リスクと対策

1. リスク: Sentisの対応opset・演算子制約によりモデルが動作しない。
- 対策: opset 15前提でエクスポートし、非対応演算子を事前検査する。

2. リスク: int64入力がUnity側で扱いにくい。
- 対策: エクスポータでint32化可能な入力を優先し、型変換を固定化する。

3. リスク: RVC前段処理不足でUnity単体推論が成立しない。
- 対策: 前段処理の最小実装範囲を定義し、PoC段階で早期検証する。

4. リスク: レイテンシ超過。
- 対策: モデル分割、shape固定化、実行順最適化、必要時ORTフォールバックを準備する。

## 8. 完了条件（Definition of Done）

1. `uv` ベースでONNX生成と事前検証が再現可能である。
2. Unity Sentisで対象モデルの推論が安定動作する。
3. 主要な制約・回避策・運用手順が `docs` に明文化されている。
4. 失敗時のフォールバック手順（ONNX Runtime）が実運用可能である。
